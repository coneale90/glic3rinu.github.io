<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Lessons by glic3rinu</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Lessons</h1>
        <p>Pages</p>


        <p class="view"><a href="https://github.com/glic3rinu">View My GitHub Profile</a></p>

      </header>
      <section>
        <h1>
<a name="lessons-learned-from-communitylab" class="anchor" href="#lessons-learned-from-communitylab"><span class="octicon octicon-link"></span></a>Lessons learned from CommunityLab</h1>

<ol>
<li>
<p>Change your mindset, think big
"You don't have a bunch of slivers, you have a distributed system"</p>

<ul>
<li>Create large slices to compensate for offline nodes and other failures</li>
<li>Automate <strong>everything</strong>, you don't want to manually login into any sliver</li>
</ul>
</li>
<li><p>Make your experiments idempotent
Nodes come and go, you can not assume all your slivers being on the same state.
Design experiments in such a way that can run on both, fresh and already deployed nodes.</p></li>
<li>
<p>Use concurrency for experiment deployment and for collecting the results
You <strong>really</strong> don't want to sequentially wait for half of your slivers timing out the SSH connection.
Use scripting languages like Bash. They usually integrate process management into the language itself. Just imagine how the following will look like if written in a language like Java and its threading library:</p>

<div class="highlight highlight-bash"><pre>cat sliver-mgmt-ip.list <span class="p">|</span> <span class="k">while </span><span class="nb">read </span>IP<span class="p">;</span> <span class="k">do</span>
    <span class="o">{</span> 
      scp -o <span class="nv">stricthostkeychecking</span><span class="o">=</span>no experiment.sh root@<span class="o">[</span><span class="nv">$IP</span><span class="o">]</span>: <span class="o">&amp;&amp;</span>
      ssh root@<span class="nv">$IP</span> <span class="s2">"nohup bash experiment.sh"</span> <span class="p">;</span>
    <span class="o">}</span> <span class="p">&amp;</span>
<span class="k">done</span>
</pre></div>
</li>
<li>
<p>CONFINE REST API doesn't love you too much
It's a node-oriented API, not researcher-oriented. Some <strong>essential</strong> information for your experiments may be cumbersome to obtain.
This snippet can be handy if you want to get all the mgmt IPs of your slivers and be able to start your experiment.</p>

<div class="highlight highlight-python"><pre><span class="n">SLICE_ID</span> <span class="o">=</span> <span class="mi">249</span>

<span class="c"># API calls</span>
<span class="c"># Requires "pip install confine-orm"</span>
<span class="kn">from</span> <span class="nn">orm.api</span> <span class="kn">import</span> <span class="n">Api</span>
<span class="n">controller</span> <span class="o">=</span> <span class="n">Api</span><span class="p">(</span><span class="s">'https://controller.community-lab.net/api/'</span><span class="p">)</span>
<span class="n">slivers</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">slivers</span><span class="o">.</span><span class="n">retrieve</span><span class="p">()</span>
<span class="n">slivers</span><span class="o">.</span><span class="n">retrieve_related</span><span class="p">(</span><span class="s">'node'</span><span class="p">,</span> <span class="s">'slice'</span><span class="p">)</span>

<span class="c"># Calculate sliver MGMT IP according to CONFINE addressing specs</span>
<span class="c"># https://wiki.confine-project.eu/arch:addressing</span>
<span class="n">MGMT_IPV6_PREFIX</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">testbed_params</span><span class="o">.</span><span class="n">mgmt_ipv6_prefix</span>
<span class="n">int_to_hex_str</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="s">'%.'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="s">'x'</span><span class="p">)</span> <span class="o">%</span> <span class="n">i</span>
<span class="n">split_by_len</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">l</span><span class="p">:</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">l</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">sliver</span> <span class="ow">in</span> <span class="n">slivers</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">slice__id</span><span class="o">=</span><span class="n">SLICE_ID</span><span class="p">):</span>
    <span class="n">node_id</span> <span class="o">=</span> <span class="n">sliver</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">id</span>
    <span class="n">slice_id</span> <span class="o">=</span> <span class="n">sliver</span><span class="o">.</span><span class="n">slice</span><span class="o">.</span><span class="n">id</span>
    <span class="k">for</span> <span class="n">iface</span> <span class="ow">in</span> <span class="n">sliver</span><span class="o">.</span><span class="n">interfaces</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">iface</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">'management'</span><span class="p">:</span>
            <span class="n">nr</span> <span class="o">=</span> <span class="s">'10'</span> <span class="o">+</span> <span class="n">int_to_hex_str</span><span class="p">(</span><span class="n">iface</span><span class="o">.</span><span class="n">nr</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">node_id</span> <span class="o">=</span> <span class="n">int_to_hex_str</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">slice_id</span> <span class="o">=</span> <span class="n">int_to_hex_str</span><span class="p">(</span><span class="n">slice_id</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
            <span class="n">ipv6_words</span> <span class="o">=</span> <span class="n">MGMT_IPV6_PREFIX</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">':'</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">ipv6_words</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">node_id</span><span class="p">,</span> <span class="n">nr</span><span class="p">])</span>
            <span class="n">ipv6_words</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">split_by_len</span><span class="p">(</span><span class="n">slice_id</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="k">print</span> <span class="s">':'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ipv6_words</span><span class="p">)</span>
            <span class="k">break</span>
</pre></div>
</li>
<li><p>Pre-compile things on your own i686 virtual machine
At the time of writting this, common sliver free-space is arround ~700MB, which may be not enough for installing required dev libraries and compiling your average C++ application.
Moreover, doing so in an overcrowded Intel Atom machine will take like... I don't know, 10x more than in your high-end desktop?</p></li>
<li><p>Be prepared for network issues
Not all nodes have Internet connectivity, "apt-get install" will not always work
Network splits are common around CN. You may end-up having multiple isolated experiments rather than a single one.</p></li>
<li>
<p>Common development tools and network utils are missing :(
Add this to your "experiment.sh" and hope for Internet connectivity being available.</p>

<div class="highlight highlight-bash"><pre>apt-get update <span class="o">&amp;&amp;</span> <span class="se">\</span>
apt-get install -y inetutils-ping git traceroute tcpdump nano strace screen
</pre></div>

<p>You also can create your own sliver templates, but you'll have to learn a few things that you don't want to.</p>
</li>
<li><p>Did you forgot to set the slice state to start?
Me too :)</p></li>
</ol>
      </section>
      <footer>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>